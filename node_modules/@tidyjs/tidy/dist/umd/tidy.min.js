(function(l,h){typeof exports=="object"&&typeof module!="undefined"?h(exports,require("d3-array")):typeof define=="function"&&define.amd?define(["exports","d3-array"],h):(l=typeof globalThis!="undefined"?globalThis:l||self,h(l.Tidy={},l.d3))})(this,function(l,h){"use strict";function z(n,...t){if(typeof n=="function")throw new Error("You must supply the data as the first argument to tidy()");let e=n;for(const r of t)e=r(e);return e}function sn(n){return e=>e.filter(n)}function ln(n,t){return r=>{if(typeof n=="function"){if(!n(r))return r}else if(!n)return r;return z(r,...t)}}function fn(n){return e=>e.map(n)}function S(n){return n==null?[]:Array.isArray(n)?n:[n]}function an(n){return e=>{if(n=S(n),!n.length){const u=new Set;for(const s of e)u.add(s);return Array.from(u)}const r=new Map,o=[],c=n[n.length-1];for(const u of e){let s=r,f=!1;for(const d of n){const a=typeof d=="function"?d(u):u[d];if(d===c){f=s.has(a),f||(o.push(u),s.set(a,!0));break}s.has(a)||s.set(a,new Map),s=s.get(a)}}return o}}function I(n){return e=>{const r=S(n).map(o=>typeof o=="function"?o:V(o));return e.slice().sort((o,c)=>{for(const u of r){const s=u(o,c);if(s)return s}return 0})}}function V(n){return function(e,r){return N(e[n],r[n],!1)}}function B(n){return function(e,r){return N(e[n],r[n],!0)}}function mn(n,t,e){let{position:r="start"}=e!=null?e:{};const o=r==="end"?-1:1,c=new Map;for(let s=0;s<t.length;++s)c.set(t[s],s);const u=typeof n=="function"?n:s=>s[n];return function(f,d){var a,i;const m=(a=c.get(u(f)))!=null?a:-1,y=(i=c.get(u(d)))!=null?i:-1;return m>=0&&y>=0?m-y:m>=0?o*-1:y>=0?o*1:0}}function N(n,t,e){let r=e?t:n,o=e?n:t;if($(r)&&$(o)){const s=(r!==r?0:r===null?1:2)-(o!==o?0:o===null?1:2);return e?-s:s}return $(r)?e?-1:1:$(o)?e?1:-1:h.ascending(r,o)}function $(n){return n==null||n!==n}function D(n,t){return r=>{t=t!=null?t:{};const o={},c=Object.keys(n);for(const u of c)o[u]=n[u](r);if(t.rest&&r.length){const u=Object.keys(r[0]);for(const s of u)c.includes(s)||(o[s]=t.rest(s)(r))}return[o]}}function E(n,t,e,r){if(!n.length)return[];const o={};let c;if(r==null)c=Object.keys(n[0]);else{c=[];for(const u of S(r))typeof u=="function"?c.push(...u(n)):c.push(u)}for(const u of c){if(e){const s=n.map(f=>f[u]);if(!e(s))continue}o[u]=t(u)(n)}return[o]}function J(n){return e=>E(e,n)}function G(n,t){return r=>E(r,t,n)}function H(n,t){return r=>E(r,t,void 0,n)}function w(n){return e=>{const r=[];for(const o of e){const c={...o};for(const u in n){const s=n[u],f=typeof s=="function"?s(c):s;c[u]=f}r.push(c)}return r}}function dn(n,t){return r=>{const o=D(n)(r),c=w(t)(o);return[...r,...c]}}function yn(n,t){return r=>{const o=J(n)(r),c=w(t)(o);return[...r,...c]}}function pn(n,t,e){return o=>{const c=G(n,t)(o),u=w(e)(c);return[...o,...u]}}function hn(n,t,e){return o=>{const c=H(n,t)(o),u=w(e)(c);return[...o,...u]}}function T(n,t){return{...n,...t.reduce((e,r)=>(e[r[0]]=r[1],e),{})}}function C(n,t,e,r,o,c=0){for(const[u,s]of n.entries()){const f=[...e,u];if(s instanceof Map){const d=r(t,f,c);C(s,d,f,r,o,c+1)}else o(t,f,s,c)}return t}function gn(n,t,e=r=>r[r.length-1]){function r(u,s){const f=new Map;return u.set(e(s),f),f}function o(u,s,f){u.set(e(s),t(f,s))}const c=new Map;return C(n,c,[],r,o),c}const O=n=>n;function v(n,t,e){return o=>{const c=vn(o,n),u=_n(c,t,e==null?void 0:e.addGroupKeys);if(e==null?void 0:e.export)switch(e.export){case"grouped":return u;case"entries":return j(u,{...e,export:"levels",levels:["entries"]});case"entries-object":case"entries-obj":case"entriesObject":return j(u,{...e,export:"levels",levels:["entries-object"]});case"object":return j(u,{...e,export:"levels",levels:["object"]});case"map":return j(u,{...e,export:"levels",levels:["map"]});case"keys":return j(u,{...e,export:"levels",levels:["keys"]});case"values":return j(u,{...e,export:"levels",levels:["values"]});case"levels":return j(u,e)}return bn(u,e==null?void 0:e.addGroupKeys)}}v.grouped=n=>({...n,export:"grouped"}),v.entries=n=>({...n,export:"entries"}),v.entriesObject=n=>({...n,export:"entries-object"}),v.object=n=>({...n,export:"object"}),v.map=n=>({...n,export:"map"}),v.keys=n=>({...n,export:"keys"}),v.values=n=>({...n,export:"values"}),v.levels=n=>({...n,export:"levels"});function _n(n,t,e){let r=n;if(!(t==null?void 0:t.length))return r;for(const o of t)r=gn(r,(c,u)=>{let f=o(c,{groupKeys:u});return e!==!1&&(f=f.map(d=>T(d,u))),f});return r}function vn(n,t){const e=S(t).map((o,c)=>{let u;typeof o=="function"?u=o.name?o.name:`group_${c}`:u=o.toString();const s=typeof o=="function"?o:d=>d[o],f=new Map;return d=>{const a=s(d);if(f.has(a))return f.get(a);const i=[u,a];return f.set(a,i),i}});return h.group(n,...e)}function bn(n,t){const e=[];return C(n,e,[],O,(r,o,c)=>{let u=c;t!==!1&&(u=c.map(s=>T(s,o))),r.push(...u)}),e}const Sn=n=>n.join("/");function kn(n){var t;const{flat:e,single:r,mapLeaf:o=O,mapLeaves:c=O,addGroupKeys:u}=n;let s;return n.flat&&(s=(t=n.compositeKey)!=null?t:Sn),{groupFn:(a,i)=>r?o(u===!1?a[0]:T(a[0],i)):c(a.map(m=>o(u===!1?m:T(m,i)))),keyFn:e?a=>s(a.map(i=>i[1])):a=>a[a.length-1][1]}}function j(n,t){const{groupFn:e,keyFn:r}=kn(t);let{mapEntry:o=O}=t;const{levels:c=["entries"]}=t,u=[];for(const a of c)switch(a){case"entries":case"entries-object":case"entries-obj":case"entriesObject":{const i=(a==="entries-object"||a==="entries-obj"||a==="entriesObject")&&t.mapEntry==null?([m,y])=>({key:m,values:y}):o;u.push({id:"entries",createEmptySubgroup:()=>[],addSubgroup:(m,y,g,b)=>{m.push(i([g,y],b))},addLeaf:(m,y,g,b)=>{m.push(i([y,g],b))}});break}case"map":u.push({id:"map",createEmptySubgroup:()=>new Map,addSubgroup:(i,m,y)=>{i.set(y,m)},addLeaf:(i,m,y)=>{i.set(m,y)}});break;case"object":u.push({id:"object",createEmptySubgroup:()=>({}),addSubgroup:(i,m,y)=>{i[y]=m},addLeaf:(i,m,y)=>{i[m]=y}});break;case"keys":u.push({id:"keys",createEmptySubgroup:()=>[],addSubgroup:(i,m,y)=>{i.push([y,m])},addLeaf:(i,m)=>{i.push(m)}});break;case"values":u.push({id:"values",createEmptySubgroup:()=>[],addSubgroup:(i,m)=>{i.push(m)},addLeaf:(i,m,y)=>{i.push(y)}});break;default:typeof a=="object"&&u.push(a)}const s=(a,i,m)=>{var y,g;if(t.flat)return a;const b=(y=u[m])!=null?y:u[u.length-1],A=((g=u[m+1])!=null?g:b).createEmptySubgroup();return b.addSubgroup(a,A,r(i),m),A},f=(a,i,m,y)=>{var g;((g=u[y])!=null?g:u[u.length-1]).addLeaf(a,r(i),e(m,i),y)},d=u[0].createEmptySubgroup();return C(n,d,[],s,f)}function P(){return n=>n.length}function Y(n){const t=typeof n=="function"?n:e=>e[n];return e=>h.fsum(e,t)}function Z(n){return e=>{const{name:r="n",wt:o}=n!=null?n:{};return D({[r]:o==null?P():Y(o)})(e)}}function jn(n,t){return r=>{t=t!=null?t:{};const{name:o="n",sort:c}=t;return z(r,v(n,[Z(t)]),c?I(B(o)):O)}}function wn(n){return e=>e.map(r=>{var o;const c={},u=Object.keys(r);for(const s of u){const f=(o=n[s])!=null?o:s;c[f]=r[s]}return c})}function R(n,t){return r=>r.slice(n,t)}const Mn=n=>R(0,n),Kn=n=>R(-n);function Fn(n,t){return r=>I(t)(r).slice(0,n)}function In(n,t){return r=>I(t)(r).slice(-n).reverse()}function On(n,t){t=t!=null?t:{};const{replace:e}=t;return o=>{if(!o.length)return o.slice();if(e){const c=[];for(let u=0;u<n;++u)c.push(o[Math.floor(Math.random()*o.length)]);return c}return h.shuffle(o.slice()).slice(0,n)}}function Q(n,t){if(n.length===0||t.length===0)return{};const e=Object.keys(n[0]),r=Object.keys(t[0]),o={};for(const c of e)r.includes(c)&&(o[c]=c);return o}function X(n){if(Array.isArray(n)){const t={};for(const e of n)t[e]=e;return t}else if(typeof n=="object")return n;return{[n]:n}}function x(n,t,e){for(const r in e){const o=e[r];if(n[o]!==t[r])return!1}return!0}function An(n,t){return r=>{const o=(t==null?void 0:t.by)==null?Q(r,n):X(t.by);return r.flatMap(u=>n.filter(f=>x(u,f,o)).map(f=>({...u,...f})))}}function nn(n,t){return r=>{const o=(t==null?void 0:t.by)==null?Q(r,n):X(t.by);return r.flatMap(u=>{const s=n.filter(f=>x(u,f,o));return s.length?s.map(f=>({...u,...f})):u})}}function zn(n){return e=>{const r=e.map(o=>({...o}));for(const o in n){const c=n[o],u=typeof c=="function"?c(r):c,s=(u==null?void 0:u[Symbol.iterator])&&typeof u!="string"?u:e.map(()=>u);let f=-1;for(const d of r)d[o]=s[++f]}return r}}function M(n){return n.length<1?[]:Object.keys(n[0])}function en(){return n=>M(n)}function tn(n,t){let e=[];for(const c of S(t))typeof c=="function"?e.push(...c(n)):e.push(c);e.length&&e[0][0]==="-"&&(e=[...en()(n),...e]);const r={},o=[];for(let c=e.length-1;c>=0;c--){const u=e[c];if(u[0]==="-"){r[u.substring(1)]=!0;continue}if(r[u]){r[u]=!1;continue}o.unshift(u)}return e=Array.from(new Set(o)),e}function W(n){return e=>{let r=tn(e,n);return r.length?e.map(o=>{const c={};for(const u of r)c[u]=o[u];return c}):e}}function $n(n){return e=>{const r=w(n)(e);return W(Object.keys(n))(r)}}function un(n){return e=>typeof n=="function"?[...e,...S(n(e))]:[...e,...S(n)]}function Tn(n){return e=>{const{namesFrom:r,valuesFrom:o,valuesFill:c,valuesFillMap:u,namesSep:s="_"}=n,f=Array.isArray(r)?r:[r],d=Array.isArray(o)?o:[o],a=[];if(!e.length)return a;const i=Object.keys(e[0]).filter(p=>!f.includes(p)&&!d.includes(p)),m={};for(const p of e)for(const _ of f)m[_]==null&&(m[_]={}),m[_][p[_]]=!0;const y=[];for(const p in m)y.push(Object.keys(m[p]));const g={},b=Cn(s,y);for(const p of b){if(d.length===1){g[p]=u!=null?u[d[0]]:c;continue}for(const _ of d)g[`${_}${s}${p}`]=u!=null?u[_]:c}function K(p){if(!p.length)return[];const _={...g};for(const k of i)_[k]=p[0][k];for(const k of p){const q=f.map(F=>k[F]).join(s);if(d.length===1){_[q]=k[d[0]];continue}for(const F of d)_[`${F}${s}${q}`]=k[F]}return[_]}return i.length?z(e,v(i,[K])):K(e)}}function Cn(n="_",t){function e(o,c,u){if(!u.length&&c!=null){o.push(c);return}const s=u[0],f=u.slice(1);for(const d of s)e(o,c==null?d:`${c}${n}${d}`,f)}const r=[];return e(r,null,t),r}function Ln(n){return e=>{var r;const{namesTo:o,valuesTo:c,namesSep:u="_"}=n,s=(r=n.cols)!=null?r:[],f=tn(e,s),d=Array.isArray(o)?o:[o],a=Array.isArray(c)?c:[c],i=d.length>1,m=a.length>1,y=[];for(const g of e){const b=Object.keys(g).filter(p=>!f.includes(p)),K={};for(const p of b)K[p]=g[p];const A=m?Array.from(new Set(f.map(p=>p.substring(p.indexOf(u)+1)))):f;for(const p of A){const _={...K};for(const k of a){const q=m?`${k}${u}${p}`:p,F=i?p.split(u):[p];let ie=0;for(const me of d){const de=F[ie++];_[me]=de,_[k]=g[q]}}y.push(_)}}return y}}function rn(n){return e=>{const r=Dn(n),o=[];for(const c in r){const u=r[c];let s;typeof u=="function"?s=u(e):Array.isArray(u)?s=u:s=Array.from(new Set(e.map(f=>f[c]))),o.push(s.map(f=>({[c]:f})))}return qn(o)}}function qn(n){function t(r,o,c){if(!c.length&&o!=null){r.push(o);return}const u=c[0],s=c.slice(1);for(const f of u)t(r,{...o,...f},s)}const e=[];return t(e,null,n),e}function Dn(n){if(Array.isArray(n)){const t={};for(const e of n)t[e]=e;return t}else if(typeof n=="object")return n;return{[n]:n}}function on(n,t=1){let[e,r]=h.extent(n);const o=[];let c=e;for(;c<=r;)o.push(c),c+=t;return o}function U(n,t="day",e=1){let[r,o]=h.extent(n);const c=[];let u=new Date(r);for(;u<=o;)if(c.push(new Date(u)),t==="second"||t==="s"||t==="seconds")u.setUTCSeconds(u.getUTCSeconds()+1*e);else if(t==="minute"||t==="min"||t==="minutes")u.setUTCMinutes(u.getUTCMinutes()+1*e);else if(t==="day"||t==="d"||t==="days")u.setUTCDate(u.getUTCDate()+1*e);else if(t==="week"||t==="w"||t==="weeks")u.setUTCDate(u.getUTCDate()+7*e);else if(t==="month"||t==="m"||t==="months")u.setUTCMonth(u.getUTCMonth()+1*e);else if(t==="year"||t==="y"||t==="years")u.setUTCFullYear(u.getUTCFullYear()+1*e);else throw new Error("Invalid granularity for date sequence: "+t);return c}function En(n,t){return function(r){t=t!=null?t:1;const o=typeof n=="function"?n:c=>c[n];return on(r.map(o),t)}}function Rn(n,t,e){return function(o){t=t!=null?t:"day",e=e!=null?e:1;const c=typeof n=="function"?n:u=>u[n];return U(o.map(c),t,e)}}function Wn(n,t,e){return function(o){t=t!=null?t:"day",e=e!=null?e:1;const c=typeof n=="function"?n:u=>u[n];return U(o.map(u=>new Date(c(u))),t,e).map(u=>u.toISOString())}}function cn(n){return e=>{const r=[];for(const o of e){const c={...o};for(const u in n)c[u]==null&&(c[u]=n[u]);r.push(c)}return r}}function Un(n,t){return r=>{const o=rn(n)(r),c=nn(r)(o);return t?cn(t)(c):c}}function Vn(n){return e=>{const r=S(n),o={};return e.map(c=>{const u={...c};for(const s of r)u[s]!=null?o[s]=u[s]:o[s]!=null&&(u[s]=o[s]);return u})}}function Bn(n,t){return(r,o)=>{var c;let u="[tidy.debug";if((c=o==null?void 0:o.groupKeys)==null?void 0:c.length){const y=o.groupKeys.map(g=>g.join(": ")).join(", ");y.length&&(u+="|"+y)}t=t!=null?t:{};const{limit:s=10,output:f="table"}=t,d="--------------------------------------------------------------------------------";let a=d.length;const i=u+"]"+(n==null?"":" "+n);return a=Math.max(0,a-(i.length+2)),console.log(`${i} ${d.substring(0,a)}`),console[f](s==null||s>=r.length?r:r.slice(0,s)),r}}function L(n,t,e){return n==null||t==null?void 0:t===0&&n===0?0:!e&&t===0?void 0:n/t}var Nn=Object.freeze({__proto__:null,rate:L});function Jn(n,t,e){const r=typeof n=="function"?n:s=>s[n],o=typeof t=="function"?t:s=>s[t],{predicate:c,allowDivideByZero:u}=e!=null?e:{};return c==null?s=>{const f=o(s),d=r(s);return L(d,f,u)}:s=>{if(!c(s))return;const f=o(s),d=r(s);return L(d,f,u)}}function Gn(n,t){let e=new h.Adder,r=0;return Float64Array.from(n,o=>e.add(+(t(o,r++,n)||0)))}function Hn(n,t){let e=0;for(let r=0;r<n.length;++r){const o=t(n[r],r,n);+o===o&&(e+=1)}return e?h.fsum(n,t)/e:void 0}function Pn(n){const t=typeof n=="function"?n:e=>e[n];return e=>Gn(e,t)}function Yn(n,t,e){const{partial:r=!1}=e!=null?e:{};return o=>o.map((c,u)=>{const s=u;if(!r&&s-n+1<0)return;const f=Math.max(0,s-n+1),d=o.slice(f,s+1);return t(d,s)})}function Zn(n){const t=typeof n=="function"?n:e=>e[n];return e=>h.min(e,t)}function Qn(n){const t=typeof n=="function"?n:e=>e[n];return e=>h.max(e,t)}function Xn(n){const t=typeof n=="function"?n:e=>e[n];return e=>Hn(e,t)}function xn(n,t){const e=typeof n=="function"?n:o=>o[n],r=typeof t=="function"?t:o=>o[t];return o=>{const c=h.fsum(o,e),u=h.fsum(o,r);return L(c,u)}}function ne(n){const t=typeof n=="function"?n:e=>e[n];return e=>h.median(e,t)}function ee(n){const t=typeof n=="function"?n:e=>e[n];return e=>h.deviation(e,t)}function te(n){const t=typeof n=="function"?n:e=>e[n];return e=>h.variance(e,t)}function ue(n){const t=typeof n=="function"?n:e=>e[n];return e=>e.length?t(e[0]):void 0}function re(n){const t=typeof n=="function"?n:e=>e[n];return e=>e.length?t(e[e.length-1]):void 0}function oe(n,t=!0){return e=>{const r=new RegExp(`^${n}`,t?"i":void 0);return M(e).filter(c=>r.test(c))}}function ce(n,t=!0){return e=>{const r=new RegExp(`${n}$`,t?"i":void 0);return M(e).filter(c=>r.test(c))}}function se(n,t=!0){return e=>{const r=new RegExp(n,t?"i":void 0);return M(e).filter(c=>r.test(c))}}function le(n){return t=>M(t).filter(r=>n.test(r))}function fe(n,t,e){return r=>{const o=M(r),c=[];for(let u=t[0];u<=t[1];++u){const s=e==null?u:new String("00000000"+u).slice(-e);c.push(`${n}${s}`)}return o.filter(u=>c.includes(u))}}function ae(n){return t=>{let e=new Set;for(const o of S(n))if(typeof o=="function"){const c=o(t);for(const u of c)e.add(u)}else e.add(o);return Array.from(e).map(o=>`-${o}`)}}l.TMath=Nn,l.addItems=un,l.addRows=un,l.arrange=I,l.asc=V,l.complete=Un,l.contains=se,l.count=jn,l.cumsum=Pn,l.debug=Bn,l.desc=B,l.deviation=ee,l.distinct=an,l.endsWith=ce,l.everything=en,l.expand=rn,l.fill=Vn,l.filter=sn,l.first=ue,l.fixedOrder=mn,l.fullSeq=En,l.fullSeqDate=Rn,l.fullSeqDateISOString=Wn,l.groupBy=v,l.innerJoin=An,l.last=re,l.leftJoin=nn,l.map=fn,l.matches=le,l.max=Qn,l.mean=Xn,l.meanRate=xn,l.median=ne,l.min=Zn,l.mutate=w,l.mutateWithSummary=zn,l.n=P,l.negate=ae,l.numRange=fe,l.pick=W,l.pivotLonger=Ln,l.pivotWider=Tn,l.rate=Jn,l.rename=wn,l.replaceNully=cn,l.roll=Yn,l.select=W,l.slice=R,l.sliceHead=Mn,l.sliceMax=In,l.sliceMin=Fn,l.sliceSample=On,l.sliceTail=Kn,l.sort=I,l.startsWith=oe,l.sum=Y,l.summarize=D,l.summarizeAll=J,l.summarizeAt=H,l.summarizeIf=G,l.tally=Z,l.tidy=z,l.total=dn,l.totalAll=yn,l.totalAt=hn,l.totalIf=pn,l.transmute=$n,l.variance=te,l.vectorSeq=on,l.vectorSeqDate=U,l.when=ln,Object.defineProperty(l,"__esModule",{value:!0})});
//# sourceMappingURL=tidy.min.js.map
